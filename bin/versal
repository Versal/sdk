#!/usr/bin/env node

'use strict';

var coffee = require('coffee-script');
var _ = require('underscore');

// Commands that are displayed in cli help
var commands = ["create", "preview", "publish", "docs"];
// Debug commands are not displayed in cli help, but still runnable
var debugCommands = ["validate", "compile", "compress", "upload"];

var usageMessage = "Versal Gadget SDK. Usage: versal (" + commands.join(" | ") + ") [directories] [--options] [--version]";

var argv = require("optimist")
  .usage(usageMessage)
  .check(function(argv) {
    if (argv.version) {
      console.log(require('../package.json').version);
      process.exit();
    }
    if (argv._.length == 0) throw new Error('command has not been specified');

    command = argv._[0];
    if (!_.contains(commands.concat(debugCommands), command)) throw new Error('invalid command: ' + command);
    return true;
  })
  .argv;

var sdk = require('../src/sdk');
// command itself is first argument
var command = argv._.shift();
// if no dirs were specified after `versal something` then
// run command from current `.` directory
if(!argv._.length) argv._.push('.');
// options - the rest of argv besides the special fields
var options = _.omit(_.clone(argv), '_', '$0');

try{
  sdk[command].apply(null, [argv._, options, function(err){
    if(err) console.log(err);
  }]);
} catch(err) {
  console.log(err);
}